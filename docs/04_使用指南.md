# Honlnk-AI-Service使用指南

## 快速开始

### 1. 环境准备

#### 系统要求
- Java 17或更高版本
- Maven 3.6.0或更高版本
- Git（可选，用于克隆项目）

#### 安装和配置
```bash
# 克隆项目
git clone <your-project-repo>
cd honlnk-ai-service

# 或者直接在现有项目中操作
```

### 2. 项目构建

```bash
# 编译项目
mvn clean compile

# 构建可执行JAR
mvn clean package

# 运行应用
mvn spring-boot:run
```

### 3. 访问应用
- 应用启动后，默认端口为8080
- H2数据库控制台：http://localhost:8080/h2-console
- 数据库连接URL：jdbc:h2:mem:testdb

## 核心功能使用

### 1. 模型配置管理

#### 创建新模型配置

使用POST请求创建新的模型配置：

```bash
curl -X POST http://localhost:8080/api/models \
  -H "Content-Type: application/json" \
  -d '{
    "modelName": "gpt-3.5-turbo",
    "baseUrl": "https://api.openai.com",
    "apiKey": "your-api-key-here",
    "modelDescription": "OpenAI GPT-3.5 Turbo模型",
    "type": "openai",
    "temperature": 0.7,
    "topP": 0.9,
    "isDefault": false,
    "headers": {
      "Authorization": "Bearer your-api-key-here"
    }
  }'
```

#### 获取所有模型配置

```bash
curl -X GET http://localhost:8080/api/models
```

#### 设置默认模型

```bash
curl -X PUT http://localhost:8080/api/models/{model-id}/default
```

### 2. AI对话功能

#### 与默认模型对话

```bash
curl -X POST http://localhost:8080/api/models/chat \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d 'message=你好，请介绍一下你自己'
```

#### 与指定模型对话

```bash
curl -X POST http://localhost:8080/api/models/chat \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d 'modelName=gpt-3.5-turbo&message=你好'
```

### 3. 数据库操作

#### H2数据库控制台
1. 打开浏览器访问：http://localhost:8080/h2-console
2. 设置JDBC URL：`jdbc:h2:mem:testdb`
3. 用户名：`sa`
4. 密码：`password`
5. 点击"连接"

#### dynamic_models表结构
| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键，自动增长 |
| base_url | VARCHAR | API基础URL |
| api_key | VARCHAR | API密钥 |
| headers | VARCHAR | 自定义HTTP头（JSON格式存储） |
| model_name | VARCHAR | 模型名称 |
| model_description | VARCHAR | 模型描述 |
| type | VARCHAR | 模型类型 |
| is_default | BOOLEAN | 是否为默认模型 |
| temperature | DOUBLE | 温度参数 |
| top_p | DOUBLE | Top-P参数 |
| completions_path | VARCHAR | 完成路径 |

## 配置说明

### 1. application.yml配置

```yaml
server:
  port: 8080  # 服务端口

spring:
  application:
    name: honlnk-ai-service  # 应用名称
  
  datasource:
    url: jdbc:h2:mem:testdb  # 内存数据库URL
    driver-class-name: org.h2.Driver
    username: sa
    password: password
  
  jpa:
    database-platform: org.hibernate.dialect.H2Dialect
    hibernate:
      ddl-auto: create-drop  # 开发环境自动创建表
    show-sql: true  # 显示SQL语句
  
  h2:
    console:
      enabled: true  # 启用H2控制台
  
  ai:
    autoconfigure:
      exclude:
        - org.springframework.ai.autoconfigure.openai.OpenAiAutoConfiguration
        - org.springframework.ai.model.chat.client.autoconfigure.ChatClientAutoConfiguration
```

### 2. 依赖说明

- `spring-ai-openai-spring-boot-starter`：提供OpenAI API支持
- `spring-boot-starter-data-jpa`：提供JPA数据访问支持
- `h2`：内存数据库，用于开发和测试
- `spring-ai-alibaba-starter-dashscope`：Spring AI Alibaba支持

## 扩展使用

### 1. 支持其他AI模型

#### 添加阿里云通义千问支持
在模型配置中使用以下配置：
```json
{
  "modelName": "qwen-max",
  "baseUrl": "https://dashscope.aliyuncs.com/compatible-mode/v1",
  "apiKey": "your-dashscope-api-key",
  "modelDescription": "阿里云通义千问Max模型",
  "type": "dashscope"
}
```

#### 添加Anthropic Claude支持
```json
{
  "modelName": "claude-3-opus-20240229",
  "baseUrl": "https://api.anthropic.com/v1",
  "apiKey": "your-anthropic-api-key",
  "modelDescription": "Anthropic Claude 3 Opus模型",
  "type": "anthropic"
}
```

### 2. 高级配置选项

#### 温度和Top-P参数
- `temperature`：控制输出的随机性，范围0.0-2.0
  - 较低值（0.2）：更确定性、重复性高的输出
  - 较高值（0.8）：更多样化、创造性的输出
- `topP`：核采样参数，范围0.0-1.0
  - 控制模型考虑的概率质量阈值

#### 自定义HTTP头
```json
{
  "headers": {
    "Authorization": "Bearer your-api-key",
    "User-Agent": "Custom-User-Agent",
    "Custom-Header": "Custom-Value"
  }
}
```

### 3. 缓存管理

#### 查看缓存状态
通过LlmService提供的方法可以查看缓存状态：

```java
@GetMapping("/cache/size")
public int getCacheSize() {
    return llmService.getChatClientCacheSize();
}
```

#### 清空缓存
```java
@PostMapping("/cache/clear")
public String clearCache() {
    llmService.clearAllChatClientCache();
    return "Cache cleared successfully";
}
```

## 开发指南

### 1. 自定义模型支持

#### 扩展DynamicModelEntity
可以根据需要添加更多字段：

```java
// 添加最大令牌数限制
@Column
private Integer maxTokens;

// 添加系统提示
@Column(length = 2000)
private String systemPrompt;

// 添加模型供应商信息
@Column
private String provider;
```

#### 自定义ChatModel创建逻辑
```java
private ChatModel createCustomChatModel(DynamicModelEntity dynamicModelEntity) {
    // 根据model type创建不同类型的ChatModel
    switch (dynamicModelEntity.getType()) {
        case "openai":
            return createOpenAiChatModel(dynamicModelEntity);
        case "dashscope":
            return createDashScopeChatModel(dynamicModelEntity);
        default:
            throw new IllegalArgumentException("Unsupported model type: " + dynamicModelEntity.getType());
    }
}
```

### 2. 安全增强

#### API Key加密存储
```java
// 在保存前加密
@PrePersist
@PreUpdate
public void encryptApiKey() {
    if (this.apiKey != null && !isEncrypted(this.apiKey)) {
        this.apiKey = encrypt(this.apiKey);
    }
}

// 在使用前解密
public String getDecryptedApiKey() {
    if (isEncrypted(this.apiKey)) {
        return decrypt(this.apiKey);
    }
    return this.apiKey;
}
```

#### 访问控制
可以添加Spring Security保护API端点：

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.authorizeHttpRequests(authz -> authz
            .requestMatchers("/api/models/**").authenticated()
            .anyRequest().permitAll()
        )
        .httpBasic(withDefaults());
        return http.build();
    }
}
```

### 3. 监控和日志

#### 添加监控指标
```java
@Autowired
private MeterRegistry meterRegistry;

public ChatClient getChatClient(String modelName) {
    // ... 创建ChatClient的逻辑
    
    // 记录指标
    meterRegistry.counter("ai.requests", "model", modelName).increment();
    
    return client;
}
```

#### 详细日志记录
在application.yml中配置详细日志：

```yaml
logging:
  level:
    com.honlnk.ai.server.ai_server: DEBUG
    org.springframework.ai: DEBUG
    org.springframework.web: DEBUG
```

## 常见问题

### 1. 启动问题

#### 依赖下载失败
确保Maven仓库配置正确：

```xml
<repositories>
    <repository>
        <id>spring-milestones</id>
        <name>Spring Milestones</name>
        <url>https://repo.spring.io/milestone</url>
        <snapshots>
            <enabled>false</enabled>
        </snapshots>
    </repository>
</repositories>
```

#### 端口冲突
更改application.yml中的端口：

```yaml
server:
  port: 9090  # 更改端口号
```

### 2. 模型配置问题

#### API Key无效
- 检查API Key是否正确
- 确认API Key对应的模型服务是否可用
- 验证API Key的权限范围

#### 模型不响应
- 检查base URL是否正确
- 确认网络连接是否正常
- 验证模型名称是否正确

### 3. 数据库问题

#### 表结构未创建
确保JPA配置正确：

```yaml
spring:
  jpa:
    hibernate:
      ddl-auto: create-drop  # 开发环境自动创建表
```

#### 数据查询失败
检查实体类注解是否正确：

```java
@Entity
@Table(name = "dynamic_models")
public class DynamicModelEntity { ... }
```

## 生产环境部署

### 1. 数据库配置

#### 使用生产级数据库
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/ai_service?useSSL=false&serverTimezone=UTC
    username: your_username
    password: your_password
    driver-class-name: com.mysql.cj.jdbc.Driver
  jpa:
    hibernate:
      ddl-auto: validate  # 生产环境验证表结构
```

### 2. 安全配置

#### 环境变量配置
避免在配置文件中硬编码敏感信息：

```bash
# 设置环境变量
export AI_DB_USERNAME=your_db_username
export AI_DB_PASSWORD=your_db_password
```

在application.yml中引用：
```yaml
spring:
  datasource:
    username: ${AI_DB_USERNAME:sa}
    password: ${AI_DB_PASSWORD:password}
```

### 3. 性能优化

#### 连接池配置
```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
```

#### 缓存配置
```java
@Configuration
@EnableCaching
public class CacheConfig {
    @Bean
    public CacheManager cacheManager() {
        return new ConcurrentMapCacheManager("chatClients");
    }
}
```

## 总结

Honlnk-AI-Service提供了完整的动态模型配置解决方案：

1. **核心价值**：避免在配置文件中硬编码API key
2. **灵活性**：支持运行时动态切换模型
3. **安全性**：集中管理敏感信息
4. **易扩展**：支持多种AI模型提供商
5. **生产就绪**：可直接部署到生产环境

通过本指南，您可以快速上手并根据具体需求进行定制化开发。